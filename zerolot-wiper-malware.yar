rule ZEROLOT_Stack_String_FsutilCommand
{
    meta:
        author = "Immersive Container 7"
        severity = "Critical"
        confidence = "High"
	    info = "ZEROLOT Wiper"
        
    strings:
        // Complete sequence of stack strings for "c:\windows\system32\fsutil.exe file setzerodataoffset=0 length=1048576 "
        $stack_str1 = { c7 85 74 ff ff ff 77 00 73 00 }  // "ws"
        $stack_str2 = { c7 85 78 ff ff ff 5c 00 73 00 }  // "\s"
        $stack_str3 = { c7 85 7c ff ff ff 79 00 73 00 }  // "ys"
        $stack_str4 = { c7 45 80 74 00 65 00 }           // "te"
        $stack_str5 = { c7 45 84 6d 00 33 00 }           // "m3"
        $stack_str6 = { c7 45 88 32 00 5c 00 }           // "2\"
        $stack_str7 = { c7 45 8c 66 00 73 00 }           // "fs"
        $stack_str8 = { c7 45 90 75 00 74 00 }           // "ut"
        $stack_str9 = { c7 45 94 69 00 6c 00 }           // "il"
        $stack_str10 = { c7 45 98 2e 00 65 00 }          // ".e"
        $stack_str11 = { c7 45 9c 78 00 65 00 }          // "xe"
        $stack_str12 = { c7 45 a0 20 00 66 00 }          // " f"
        $stack_str13 = { c7 45 a4 69 00 6c 00 }          // "il"
        $stack_str14 = { c7 45 a8 65 00 20 00 }          // "e "
        $stack_str15 = { c7 45 ac 73 00 65 00 }          // "se"
        $stack_str16 = { c7 45 b0 74 00 7a 00 }          // "tz"
        $stack_str17 = { c7 45 b4 65 00 72 00 }          // "er"
        $stack_str18 = { c7 45 b8 6f 00 64 00 }          // "od"
        $stack_str19 = { c7 45 bc 61 00 74 00 }          // "at"
        $stack_str20 = { c7 45 c0 61 00 20 00 }          // "a "
        $stack_str21 = { c7 45 c4 6f 00 66 00 }          // "of"
        $stack_str22 = { c7 45 c8 66 00 73 00 }          // "fs"
        $stack_str23 = { c7 45 cc 65 00 74 00 }          // "et"
        $stack_str24 = { c7 45 d0 3d 00 30 00 }          // "=0"
        $stack_str25 = { c7 45 d4 20 00 6c 00 }          // " l"
        $stack_str26 = { c7 45 d8 65 00 6e 00 }          // "en"
        $stack_str27 = { c7 45 dc 67 00 74 00 }          // "gt"
        $stack_str28 = { c7 45 e0 68 00 3d 00 }          // "h="
        $stack_str29 = { c7 45 e4 31 00 30 00 }          // "10"
        $stack_str30 = { c7 45 e8 34 00 38 00 }          // "48"
        $stack_str31 = { c7 45 ec 35 00 37 00 }          // "57"
        $stack_str32 = { c7 45 f0 36 00 30 00 }          // "60"
        $stack_str33 = { c7 45 f4 20 00 00 00 }          // " " (space + null)

        // Full continuous pattern
        $full_pattern = { 
            c7 85 74 ff ff ff 77 00 73 00 
            c7 85 78 ff ff ff 5c 00 73 00 
            c7 85 7c ff ff ff 79 00 73 00 
            c7 45 80 74 00 65 00 
            c7 45 84 6d 00 33 00 
            c7 45 88 32 00 5c 00 
            c7 45 8c 66 00 73 00 
            c7 45 90 75 00 74 00 
            c7 45 94 69 00 6c 00 
            c7 45 98 2e 00 65 00 
            c7 45 9c 78 00 65 00 
            c7 45 a0 20 00 66 00 
            c7 45 a4 69 00 6c 00 
            c7 45 a8 65 00 20 00 
            c7 45 ac 73 00 65 00 
            c7 45 b0 74 00 7a 00 
            c7 45 b4 65 00 72 00 
            c7 45 b8 6f 00 64 00 
            c7 45 bc 61 00 74 00 
            c7 45 c0 61 00 20 00 
            c7 45 c4 6f 00 66 00 
            c7 45 c8 66 00 73 00 
            c7 45 cc 65 00 74 00 
            c7 45 d0 3d 00 30 00 
            c7 45 d4 20 00 6c 00 
            c7 45 d8 65 00 6e 00 
            c7 45 dc 67 00 74 00 
            c7 45 e0 68 00 3d 00 
            c7 45 e4 31 00 30 00 
            c7 45 e8 34 00 38 00 
            c7 45 ec 35 00 37 00 
            c7 45 f0 36 00 30 00 
            c7 45 f4 20 00 00 00
        }
        
        // IOCTL codes
        $ioctl_delete_layout = { (68|B8|C7 ?? ??) 00 C1 07 00 }  // PUSH/MOV/MOV with 0x7c100
        
    condition:
        uint16(0) == 0x5A4D and  // MZ header
        (
            $full_pattern or 
            (12 of ($stack_str*)) or  // Match at least 12 of the individual stack strings
            (
                // Or match the command components plus the IOCTL
                $ioctl_delete_layout
            )
        )
}
